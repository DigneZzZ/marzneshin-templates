<html>
  <head>
    <title>{{ user.username }} - Информация о подписке</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css"
      rel="stylesheet"
      type="text/css"
    />
    <script
      src="https://kit.fontawesome.com/462198e471.js"
      crossorigin="anonymous"
    ></script>

    <style>
      ::-webkit-scrollbar {
        width: 0px;
        height: 0px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
        display: none;
      }

      ::-webkit-scrollbar-thumb {
        background: transparent;
        background: #555;
        display: none;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
        display: none;
      }

      body {
        margin: 0;
        padding: 0;
        border: 0;
        background: #1a202c;
      }

      * {
        font-family: Vazirmatn;
      }

      .main_flexor {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
      }

      .mainest_container {
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: column;
        height: 530px;
        flex-wrap: wrap;
        transition: all 0.4s;
      }

      .main_container-1 {
        width: 300px;
        height: 250px;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
        border: 1px solid #4a5568;
        background-color: #222c3b;
        border-radius: 0.75rem;
        position: relative;
      }

      .main_container-2 {
        width: 300px;
        height: 250px;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: column;
        border: 1px solid #4a5568;
        background-color: #222c3b;
        border-radius: 0.75rem;
        margin-top: 18px;
        color: white;
      }

      .container-2-selection-item {
        width: 100%;
        height: 100px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        align-content: center;
        flex-direction: row;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .container-2-selection-item img,
      .fa-i-type-1 {
        margin-left: 10px;
        margin-right: 15px;
      }

      .container-2-selection-item:hover {
        background: #1c212a;
      }

      .container-2-selection-item:first-child {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      .container-2-selection-item:last-child {
        border-bottom-left-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
      }

      .container-3-selection-items {
        width: 100%;
        color: white;
        display: flex;
        justify-content: space-around;
        align-items: center;
        align-content: center;
        flex-direction: row;
        font-size: 20px;
        margin-top: 20px;
      }

      .container-3-selection-items > span {
        width: 40%;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
        cursor: pointer;
        background: #1c212a;
        border-radius: 0.75rem;
        padding: 6px 0;
        transition: all 0.2s;
        border: 2px solid #1c212a;
      }
      .container-3-selection-items > span:hover {
        border: 2px solid #161920;
        background: #161920;
      }

      .main_container-2 > span {
        font-size: 25px;
        margin-bottom: 30px;
        margin-top: 10px;
        border-bottom: 2px solid white;
        padding-bottom: 10px;
      }

      .main_container-3 {
        width: 600px;
        height: 520px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        align-content: center;
        flex-direction: column;
        border: 1px solid #4a5568;
        background-color: #222c3b;
        border-radius: 0.75rem;
        margin-left: 20px;
        transition: all 0.4s;
      }

      .pie-chart {
        width: 120px;
        height: 120px;
        position: relative;
        display: flex;
        align-items: center;
        place-content: center;
        font-size: 30px;
        color: white;
      }

      .pie-chart:before {
        --line: 10px;
        --color: var(--c, #444);
        content: "";
        position: absolute;
        border-radius: 50%;
        inset: 0;
        background: conic-gradient(var(--color) calc(var(--p) * 1%), white 0);
        -webkit-mask: radial-gradient(
          farthest-side,
          transparent calc(99% - var(--line)),
          #000 calc(100% - var(--line))
        );
        mask: radial-gradient(
          farthest-side,
          transparent calc(99% - var(--line)),
          #000 calc(100% - var(--line))
        );
      }

      .pie-chart-1:after {
        content: " ГБ";
        font-size: 15px;
      }

      .pie-chart-2:after {
        content: " дней";
        font-size: 15px;
      }

      .charts {
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
        gap: 20px;
        flex-wrap: wrap;
      }

      .username {
        width: 100%;
        color: white;
        text-align: center;
        font-size: 30px;
        z-index: 1000;
      }

      .protocol-row {
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        align-content: center;
        flex-direction: row;
        padding: 7px;
        border-radius: 0.5rem;
        transition: all 0.2s;
        font-size: 16px;
        background: #1c212a;
        margin-top: 7px;
      }

      .protocol-row img,
      .fa-i-type-2 {
        cursor: pointer;
        margin-right: 6px;
        transition: all 0.2s;
      }

      .dropdown_item {
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        align-content: center;
        flex-direction: row;
        padding: 15px;
        transition: all 0.2s;
        height: 40px;
        background: #1c212a;
        cursor: pointer;
        margin: 0;
      }

      .frst-chld {
        border-top-right-radius: 0.75rem;
        border-top-left-radius: 0.75rem;
      }

      .last-chld {
        border-bottom-right-radius: 0.75rem;
        border-bottom-left-radius: 0.75rem;
      }

      .dropdown_item_left {
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
        gap: 20px;
        font-size: 20px;
      }

      .dropdown_desc {
        margin-top: 10px;
        width: 90%;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
        text-align: center;
        margin-bottom: 20px;
        font-size: 15px;
      }

      .dropdown_title {
        font-size: 25px;
        background: #161920;
        width: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row;
        border-bottom-left-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
      }

      .dropdown_dl {
        background: #3781be;
        padding: 10px 30px;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 20px;
        margin: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: row-reverse;
        text-decoration: none;
      }

      .dropdown_dl img,
      .fa-i-type-6 {
        margin-right: 20px;
      }

      .dropdown_dl:hover {
        background: #4299e199;
      }

      .pie-data {
        width: 40%;
        color: white;
        font-size: 11px;
        display: flex;
        justify-content: center;
        align-items: center;
        align-content: center;
        flex-direction: column;
      }
    </style>
  </head>

  <body>
    <div class="popup_container">
      <div class="ovrly"></div>
      <div class="popup_box">
        <div class="close_popup">
          <i class="fa-solid fa-xmark fa-i-type-3 close_popup_i"></i>
        </div>
        <div class="dropdown_title">FAIR VPN</div>
        <div class="dropdown_vid">
          <video class="main_dd_vid" width="400" controls>
            <source src="" type="video/mp4" />
          </video>
        </div>
        <a class="dropdown_dl" href="https://google.com">
          <span style="text-decoration: none; color: white">Скачать</span>
          <i class="fa-solid fa-download fa-i-type-6"></i>
        </a>
        <div class="dropdown_desc">
          <span>Этот текст заменён на пример русской информации, используемой для описания сервиса.</span>
        </div>
      </div>
    </div>

    <div class="qr_container">
      <div class="qr_ovrly"></div>
      <div class="qr_box">
        <div class="close_qr">
          <i class="fa-solid fa-xmark fa-i-type-3"></i>
        </div>
        <div id="qrrr"></div>
      </div>
    </div>

    <div class="main_flexor">
      <div class="mainest_container">
        <div class="main_container-1">
          {% if user.is_active and not user.expired and not user.data_limit_reached and user.enabled %}
          <!-- Активный VPN - Оверлей не нужен -->
          {% elif user.data_limit_reached %}
          <div class="sus_overlay_container">
            <div class="sus_overlay">
              <span>Ваш VPN ограничен</span>
            </div>
          </div>
          {% elif user.expired %}
          <div class="sus_overlay_container">
            <div class="sus_overlay">
              <span>Ваш VPN истек</span>
            </div>
          </div>
          {% elif not user.enabled %}
          <div class="sus_overlay_container">
            <div class="sus_overlay">
              <span>Ваш VPN отключен</span>
            </div>
          </div>
          {% else %}
          <!-- Оверлей по умолчанию для необработанных случаев -->
          <div class="sus_overlay_container">
            <div class="sus_overlay">
              <span>Статус вашего VPN не определен</span>
            </div>
          </div>
          {% endif %}
        </div>

        <div class="charts">
          <span class="username">{{ user.username }}</span>
          <span class="pie-chart pie-chart-1" style="--p: 100; --c: #4299e199">
            2.7
          </span>

          <span class="pie-chart pie-chart-2" style="--p: 100; --c: #4299e199">
            32
          </span>

          <div class="pie-data pie-data-2">
            <span>: Объем использованного трафика </span>
            <span class="data_field_1">0.6 ГБ</span>
          </div>

          <div class="pie-data pie-data-1">
            <span>: Дата окончания </span>
            <span class="data_field_2">1402 / 2 / 3</span>
          </div>
        </div>
      </div>

      <div class="main_container-2">
        <span>Дополнительная информация</span>
        <div class="container-2-selection-item info_link1">
          <i class="fa-brands fa-telegram fa-i-type-1 fa-lg"></i>
          <span>Канал в Телеграм</span>
        </div>

        <div class="container-2-selection-item info_link2">
          <i class="fa-solid fa-server fa-i-type-1 fa-lg"></i>
          <span>Статус сервера</span>
        </div>

        <div class="container-2-selection-item info_link3">
          <i class="fa-solid fa-headset fa-i-type-1 fa-lg"></i>
          <span>Поддержка</span>
        </div>
      </div>
      <div class="main_container-3">
        <div class="container-3-selection-items">
          <span style="border: 2px solid white">Ссылки</span>
          <span>Обучение</span>
        </div>
        <div class="slider_container">
          <div class="slide1">
            <div id="all-configs-container"></div>

            <script>
              document.addEventListener("DOMContentLoaded", function () {
                fetchLinks();
              });

              function fetchLinks() {
                const url = `${window.location.origin}/api/links`; // Update this with your actual API URL

                fetch(url)
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error(
                        `Network response was not ok: ${response.statusText}`
                      );
                    }
                    return response.json(); // Assuming the API returns JSON
                  })
                  .then((data) => {
                    const links = data.links || []; // Assuming the links are returned in the 'links' field
                    renderAllConfigs(links);
                  })
                  .catch((error) => {
                    console.error("Error fetching links:", error);
                  });
              }

              function renderAllConfigs(links) {
                const allConfigsContainer = document.getElementById(
                  "all-configs-container"
                );

                if (links.length === 0) {
                  allConfigsContainer.innerHTML = "<p>No links available.</p>";
                  return;
                }

                // Join all links with a new line for copying
                const allConfigsText = links.join("\n");

                // Render the "ALL CONFIGS" section
                allConfigsContainer.innerHTML = `
      <div class="protocol-row special-protocol-row">
        <span>ALL CONFIGS</span>
        <div class="icon_list">
          <i class="copy_protocol fa-regular fa-copy fa-i-type-2 fa-lg" onclick='copyAllConfigs("${allConfigsText.replace(
            /"/g,
            "&quot;"
          )}")'></i>
        </div>
      </div>
    `;
              }

              function copyAllConfigs(configs) {
                navigator.clipboard.writeText(configs).then(
                  () => {
                    console.log("All configs copied to clipboard");
                  },
                  (err) => {
                    console.error("Failed to copy configs:", err);
                  }
                );
              }
            </script>

            <div class="protocol-row special-protocol-row">
              <span>SUB LINK</span>
              <div class="icon_list">
                <i
                  class="copy_protocol fa-regular fa-copy fa-i-type-2 fa-lg"
                  onclick="copy_link('PAGE')"
                >
                </i>
                <i
                  class="qrcode fa-solid fa-qrcode fa-i-type-2 fa-lg"
                  onclick="show_qrcode('PAGE')"
                >
                </i>
              </div>
            </div>

            <div class="scrollable_view">
              <div id="protocol-list"></div>

              <script>
                document.addEventListener("DOMContentLoaded", function () {
                  fetchLinks();
                });

                function fetchLinks() {
                  const url = window.location.href;

                  fetch(url)
                    .then((response) => {
                      if (!response.ok) {
                        throw new Error(
                          `Network response was not ok: ${response.statusText}`
                        );
                      }
                      return response.json(); // Assuming the API returns JSON
                    })
                    .then((data) => {
                      const links = data.links || []; // Assuming links are returned in the 'links' field
                      renderLinks(links);
                    })
                    .catch((error) => {
                      console.error("Error fetching links:", error);
                    });
                }

                function renderLinks(links) {
                  const protocolList = document.getElementById("protocol-list");

                  if (links.length === 0) {
                    protocolList.innerHTML = "<p>No links available.</p>";
                    return;
                  }

                  protocolList.innerHTML = links
                    .map(
                      (link) => `
                                              <div class="protocol-row">
                                                <span>${link}</span>
                                                <div class="icon_list">
                                                  <i class="copy_protocol fa-regular fa-copy fa-i-type-2 fa-lg" onclick="copy_link('${link}')"></i>
                                                  <i class="qrcode fa-solid fa-qrcode fa-i-type-2 fa-lg" onclick="show_qrcode('${link}')"></i>
                                                </div>
                                              </div>
                                            `
                    )
                    .join("");
                }

                function copy_link(link) {
                  navigator.clipboard.writeText(link).then(
                    () => {
                      console.log("Link copied to clipboard:", link);
                    },
                    (err) => {
                      console.error("Failed to copy link:", err);
                    }
                  );
                }

                function show_qrcode(link) {
                  // Implement your QR code generation logic here
                  console.log("Show QR code for:", link);
                }
              </script>
            </div>
          </div>

          <div class="slide2">
            <div class="dropdown_item frst-chld" open-dd="1">
              <div class="dropdown_item_left">
                <i class="fa-brands fa-apple fa-i-type-5 fa-2x"></i>
                <span>IOS</span>
              </div>
              <i class="fa-solid fa-caret-down drop_it fa-i-type-4 fa-2x"></i>
            </div>

            <div class="dropdown_content" dropdown-id="1"></div>

            <div class="dropdown_item" open-dd="2">
              <div class="dropdown_item_left">
                <i class="fa-brands fa-android fa-i-type-5 fa-2x"></i>
                <span>ANDROID</span>
              </div>
              <i class="fa-solid fa-caret-down drop_it fa-i-type-4 fa-2x"></i>
            </div>

            <div class="dropdown_content" dropdown-id="2"></div>

            <div class="dropdown_item last-chld" open-dd="3">
              <div class="dropdown_item_left">
                <i class="fa-solid fa-desktop fa-i-type-5 fa-2x"></i>
                <span>DESKTOP</span>
              </div>
              <i class="fa-solid fa-caret-down drop_it fa-i-type-4 fa-2x"></i>
            </div>

            <div
              class="dropdown_content last_dropdown_content"
              dropdown-id="3"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      var config_obj = {
        ios: [
          {
            id: 1,
            name: "foxray",
            description: "",
            link: "https://apps.apple.com/us/app/foxray/id6448898396",
            video:
              "https://cdn.discordapp.com/attachments/1143169413617557575/1146806348428890233/foxray.mp4",
            requirement: "iOS 16.0 или выше (бесплатно)",
          },
          {
            id: 2,
            name: "v2box",
            description: "",
            link: "https://apps.apple.com/us/app/v2box-v2ray-client/id6446814690",
            video:
              "https://cdn.discordapp.com/attachments/1143169413617557575/1146806160574386286/v2box.mp4",
            requirement: "iOS 14.0 или выше (бесплатно)",
          },
          {
            id: 3,
            name: "shadow rocket",
            description: "",
            link: "https://apps.apple.com/ca/app/shadowrocket/id932747118",
            video:
              "https://cdn.discordapp.com/attachments/1143169413617557575/1146806574665453648/shadowrocket.mp4",
            requirement: "iOS 12.0 или выше ($3.99)",
          },
        ],
        android: [
          {
            id: 4,
            name: "v2rayng",
            description: "",
            link: "https://github.com/2dust/v2rayNG/releases/download/1.8.5/v2rayNG_1.8.5.apk",
            video:
              "https://cdn.discordapp.com/attachments/1143169413617557575/1144654217282334842/v2ng.mp4",
            requirement: "android 5 или выше",
          },
          {
            id: 5,
            name: "clash",
            description: "",
            link: "",
            video: "",
            requirement: "android 5 или выше",
          },
        ],
        desktop: [
          {
            id: 6,
            name: "nekoray",
            description: "",
            link: "https://github.com/MatsuriDayo/nekoray/releases/download/3.17/nekoray-3.17-2023-08-17-desktop64.zip",
            video:
              "https://cdn.discordapp.com/attachments/1143169413617557575/1146803993671123077/nekoray.mp4",
            requirement: "для настольных компьютеров",
          },
          {
            id: 7,
            name: "v2rayn",
            description: "",
            link: "https://github.com/2dust/v2rayN/releases/download/6.23/v2rayN-With-Core.zip",
            video:
              "https://cdn.discordapp.com/attachments/1143169413617557575/1143594260726296606/video_2023-08-22_20-36-41.mp4",
            requirement: "для настольных компьютеров",
          },
          {
            id: 8,
            name: "clash",
            description: "",
            link: "",
            video: "",
            requirement: "для настольных компьютеров",
          },
        ],
      };

      var info_links = {
        telegram_channel: "https://t.me/MatinDehghanian",
        server_status: "https://status.example.com",
        backup: "https://t.me/MatinDehghanian",
      };

      $(".info_link1").click(function () {
        window.location.href = info_links.telegram_channel;
      });
      $(".info_link2").click(function () {
        window.location.href = info_links.server_status;
      });
      $(".info_link3").click(function () {
        window.location.href = info_links.backup;
      });

      function b2gb(num) {
        return parseFloat((num / 1073741824).toFixed(1));
      }

      var data_limit =
        "{% if not user.data_limit %}∞{% else %}{{ user.data_limit }}{% endif %}";
      var used_traffic = "{{ user.used_traffic }}";
      var remained_traffic =
        data_limit == "∞" ? "∞" : data_limit - used_traffic;
      used_traffic = b2gb(used_traffic);

      var pie2_perc = 100;

      if (data_limit != "∞") {
        data_limit = b2gb(data_limit);
        remained_traffic = b2gb(remained_traffic);
        pie2_perc = (remained_traffic / data_limit) * 100;
      }

      var user_expire_date = "{{ user.expire_date ? user.expire_date : '∞' }}"; // Use new expire_date field
      var remaining_days = "∞";
      var expire_date = "-";

      if (user_expire_date !== "∞") {
        // Parse the new expire_date format to a timestamp
        var expire_timestamp = Date.parse(user_expire_date) / 1000; // Convert to Unix timestamp in seconds
        var current_timestamp = parseInt(Date.now() / 1000); // Current timestamp in seconds
        remaining_days = parseInt(
          (expire_timestamp - current_timestamp) / (3600 * 24)
        ); // Calculate remaining days

        // Convert the expire_timestamp to Persian date format
        expire_date = new persianDate.unix(expire_timestamp)
          .format()
          .split(" ")[0]
          .replaceAll("-", " / ");
      }

      document.querySelectorAll(".pie-chart-1")[0].innerHTML = remained_traffic;
      document.querySelectorAll(".pie-chart-2")[0].innerHTML = remaining_days;
      document.querySelectorAll(".data_field_1")[0].innerHTML =
        used_traffic + " ГБ";
      document.querySelectorAll(".data_field_2")[0].innerHTML = expire_date;
      $(".pie-chart-1").attr("style", `--p: ${pie2_perc}; --c:#4299e199`);
    </script>
  </body>
</html>
